{"version":3,"file":"custom-functions.js","mappings":"yBA+FOA,eAAeC,EAASC,EAAgBC,GAC7C,IACE,MAAMC,EAtFV,WACE,MAAMC,EAAQC,aAAaC,QAAQ,oBACnC,OAAIF,GACaG,KAAKC,MAAMJ,GACZK,cAET,EACT,CA+EkBC,GACd,IAAKP,EACH,MAAO,2EAGT,MAQMQ,EAAqB,CACzB,CAAEC,KAAM,SAAUC,QATC,+dAUnB,CAAED,KAAM,OAAQC,QAAS,oBAAoBN,KAAKO,UAAUb,iBAAyBC,MAGjFa,QAAiBC,MA7GT,0CA6G0B,CACtCC,OAAQ,OACRC,QAAS,CACP,eAAgB,mBAChB,cAAiB,UAAUf,KAE7BgB,KAAMZ,KAAKO,UAAU,CAAEH,WAAUS,QAAQ,MAG3C,IAAKL,EAASM,GAEZ,MAAO,kBADiBN,EAASO,OAAOC,MAAM,KAAM,CAAG,KAC3BC,OAAST,EAASU,aAGhD,MAAMC,QAAaX,EAASO,OAC5B,OAAOI,EAAKC,UAAU,IAAIC,SAASf,SAASgB,QAAU,0BACxD,CAAE,MAAOL,GAEP,OADAM,QAAQN,MAAM,qBAAsBA,GAC7B,WAAWA,aAAiBO,MAAQP,EAAMI,QAAU,sBAC7D,CACF,CAEAI,gBAAgBC,UAAU,WAAYjC,GACtCgC,gBAAgBC,UAAU,WAAYjC,E","sources":["webpack://dc-expert/./src/functions/functions.ts"],"sourcesContent":["/* global CustomFunctions */\n\nexport type Message = { role: \"user\" | \"system\" | \"assistant\"; content: string };\n\n// ВАЖНО: Укажите здесь URL вашего боевого прокси-сервера. \n// Для локальной разработки оставьте localhost.\nconst PROXY_URL = \"https://excelprx.hsecontest.ru/api/chat\"; \n\n/**\n * Получает сохраненный сервисный токен из LocalStorage\n */\nfunction getStoredToken(): string {\n  const saved = localStorage.getItem(\"copilot_settings\");\n  if (saved) {\n    const parsed = JSON.parse(saved);\n    return parsed.serviceToken || \"\";\n  }\n  return \"\";\n}\n\n/**\n * Внутренняя функция для стриминга ответов в чат (не торчит в Excel напрямую).\n */\nexport async function chatStream(\n  messages: Message[],\n  invocation: { setResult: (res: string) => Promise<void> | void; onCanceled: () => void }\n): Promise<void> {\n  try {\n    const token = getStoredToken();\n    if (!token) {\n      throw new Error(\"Не указан сервисный токен. Откройте настройки плагина (шестеренка) и введите токен.\");\n    }\n\n    const response = await fetch(PROXY_URL, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${token}`\n      },\n      body: JSON.stringify({ messages, stream: true })\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      throw new Error(errorData.error || `Ошибка сервера: ${response.status}`);\n    }\n\n    const reader = response.body?.getReader();\n    const decoder = new TextDecoder();\n    let fullResponse = \"\";\n\n    if (reader) {\n      for (;;) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        const chunk = decoder.decode(value, { stream: true });\n        const lines = chunk.split(\"\\n\");\n\n        for (const line of lines) {\n          if (line.startsWith(\"data: \")) {\n            const data = line.slice(6);\n            if (data.trim() === \"[DONE]\") continue;\n\n            try {\n              const parsed = JSON.parse(data);\n              const content = parsed.choices?.[0]?.delta?.content || \"\";\n              if (content) {\n                fullResponse += content;\n                await invocation.setResult(fullResponse);\n              }\n            } catch (e) {\n              // Игнорируем ошибки парсинга неполных JSON-чанков\n            }\n          }\n        }\n      }\n    }\n\n    if (!fullResponse) {\n      throw new Error(\"Получен пустой ответ от сервера.\");\n    }\n  } catch (error) {\n    console.error(\"Error in chatStream:\", error);\n    await invocation.setResult(`Ошибка: ${error instanceof Error ? error.message : \"Неизвестная ошибка\"}`);\n  }\n}\n\n/**\n * Анализирует выделенные данные с помощью DC Expert.\n * @customfunction DCEXPERT\n * @param cellValue Значение или диапазон ячеек для анализа.\n * @param query Конкретный вопрос или задача для ИИ.\n * @returns Итоговый ответ ИИ в формате текста.\n */\nexport async function dcexpert(cellValue: any, query: string): Promise<string> {\n  try {\n    const token = getStoredToken();\n    if (!token) {\n      return \"Ошибка: Не указан сервисный токен. Настройте плагин на панели DC Expert.\";\n    }\n\n    const systemPrompt = `Ты — DC Expert, профессиональный ассистент Excel. \nТвоя задача: предоставлять краткие, точные и полезные ответы на запросы пользователя по данным из ячеек.\nСТРОГИЕ ПРАВИЛА:\n1. Выдавай ТОЛЬКО результат без лишних слов, приветствий и пояснений.\n2. КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО использовать разметку Markdown (бектики \\`, звездочки *, решетки #).\n3. Весь текст должен быть простым и чистым, чтобы его можно было сразу использовать в Excel.\n4. Ответ должен быть на русском языке.`;\n\n    const messages: Message[] =[\n      { role: \"system\", content: systemPrompt },\n      { role: \"user\", content: `Данные из ячеек: ${JSON.stringify(cellValue)}\\n\\nЗапрос: ${query}` },\n    ];\n\n    const response = await fetch(PROXY_URL, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Authorization\": `Bearer ${token}`\n      },\n      body: JSON.stringify({ messages, stream: false })\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      return `Ошибка: ${errorData.error || response.statusText}`;\n    }\n\n    const data = await response.json();\n    return data.choices?.[0]?.message?.content?.trim() || \"Пустой ответ от сервера.\";\n  } catch (error) {\n    console.error(\"Error in dcexpert:\", error);\n    return `Ошибка: ${error instanceof Error ? error.message : \"Неизвестная ошибка\"}`;\n  }\n}\n\nCustomFunctions.associate(\"DCEXPERT\", dcexpert);\nCustomFunctions.associate(\"DCEXPERT\", dcexpert);"],"names":["async","dcexpert","cellValue","query","token","saved","localStorage","getItem","JSON","parse","serviceToken","getStoredToken","messages","role","content","stringify","response","fetch","method","headers","body","stream","ok","json","catch","error","statusText","data","choices","message","trim","console","Error","CustomFunctions","associate"],"sourceRoot":""}